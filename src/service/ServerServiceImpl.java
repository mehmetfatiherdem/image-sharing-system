package service;

import dto.UserDTO;
import helper.image.ImageDownloadData;
import helper.security.Authentication;
import helper.security.Confidentiality;
import helper.security.UserCertificateCredentials;
import repository.ServerRepository;

import java.io.BufferedInputStream;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.net.Socket;
import java.security.PrivateKey;
import java.util.ArrayList;
import java.util.Arrays;

public class ServerServiceImpl implements ServerService {
    private final ServerRepository serverRepository;
    private final Socket socket;

    public ServerServiceImpl(ServerRepository serverRepository, Socket socket) {
        this.serverRepository = serverRepository;
        this.socket = socket;
    }
    @Override
    public void createCertificate(UserCertificateCredentials userCertificateCredentials, PrivateKey privateKey) {
        try{
            byte[] certificate = Authentication.sign(userCertificateCredentials.getCredentialBytes(), privateKey);
            serverRepository.addCertificate(certificate);
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void sendImagePostNotification(ArrayList<UserDTO> onlineUsers, String imageName, String ownerUsername) {
        // implement this method
    }

    @Override
    public void sendImage(ImageDownloadData imageDownloadData) {

        try {
            DataOutputStream out = new DataOutputStream(socket.getOutputStream());
            out.writeUTF(imageDownloadData.getMessageString());
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public void handleRequests() {
        try {

            DataInputStream in = new DataInputStream(new BufferedInputStream(socket.getInputStream()));
            DataOutputStream out = new DataOutputStream(socket.getOutputStream());
            byte[] MAC = new byte[16];

            while (true) {

                String message = in.readUTF();
                System.out.println("message received by server: " + message);
                String[] messageParts = message.split(" ");

                String encryptedMessage = Arrays.toString(Confidentiality.decryptWithPrivateKey(message.getBytes(), serverRepository.getPrivateKey()));
                String[] encryptedMessageParts = encryptedMessage.split(" ");

                if (message.equals("ping")) {
                    out.writeUTF("pong");
                } else if (messageParts[0].equals("HELLO")) {
                    out.writeUTF( "PUBLICKEY" + " " + serverRepository.getPublicKey().toString());
                } else if (encryptedMessageParts[0].equals("MAC")) {
                    System.out.println("msg : " + encryptedMessageParts[1] + " " + encryptedMessageParts[2]);
                    MAC = Authentication.generateMAC(encryptedMessageParts[1].getBytes(), encryptedMessageParts[2].getBytes());
                    out.writeUTF("MAC generated by server: " + " " + Arrays.toString(MAC));

                } else if (messageParts[0].equals("LOGIN")) {
                    out.writeUTF("LOGIN" + " " + "success");
                } else if (messageParts[0].equals("REGISTER")) {

                } else {
                    out.writeUTF("error");
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
